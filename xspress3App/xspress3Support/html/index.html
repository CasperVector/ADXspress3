<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>xspress3api: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">xspress3api
   &#160;<span id="projectnumber">2.1.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">xspress3api Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#intro">"Introduction"</a><ul><li class="level2"><a href="#software_overview">Software Overview</a><ul><li class="level3"><a href="#software_setup">Setup procedure</a></li>
<li class="level3"><a href="#software_user_setup">User Settings</a></li>
<li class="level3"><a href="#Data">Collection</a></li>
<li class="level3"><a href="#software_data_access">Data Access</a></li>
</ul>
</li>
<li class="level2"><a href="#registers">Register Layout</a></li>
<li class="level2"><a href="#network_config">Network Configuration</a></li>
<li class="level2"><a href="#errors">Error Codes</a></li>
</ul>
</li>
<li class="level1"><a href="#revisions">"Revison History"</a></li>
</ul>
</div>
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>W.I.Helsby </dd>
<dd>
G.R.Mant </dd></dl>
<dl class="section version"><dt>Version</dt><dd>2.0.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>8/5/2014</dd></dl>
<h1><a class="anchor" id="intro"></a>
"Introduction"</h1>
<div class="image">
<img src="xspress3_drawing.png" alt="xspress3_drawing.png"/>
</div>
<p> The XSPRESS3 system contains a Xilinx Virtex-5 FPGA with two embedded PowerPC processors. PPC1 manages the DMA engines. PPC1 runs the Xilinx micro kernel and communicates to the Intel 64 bit Linux server PC by 1 GBit Ethernet, TCP sockets. Bulk data and event lists to be histogrammed are sent from the firmware to the Server PC by 10G Ethernet, UDP.</p>
<h2><a class="anchor" id="software_overview"></a>
Software Overview</h2>
<p>The software API is via the libxspress3.a which provides C calling functions with names xsp3_*. </p>
<h3><a class="anchor" id="software_setup"></a>
Setup procedure</h3>
<p>The library supports running 1 or more XSPRESS3 systems. Each system can consists of 1 or more FEM cards. To connect to a system of 1 or more boards use the command <a class="el" href="group__toplevel.html#gabbdb522cdcc0230ab9d2e06c63c4cf03">xsp3_config</a> This returns a handle which should be used to identify the system to all subsequent calls. Next setup the clock source. For normal operation the ADC and data processing clock is set to use the Crystal Oscillator module on the ADC board using xsp3_clocks_setup(path, -1, XSP3_CLK_SRC_XTAL, XSP3_CLK_FLAGS_MASTER | XSP3_CLK_FLAGS_NO_DITHER, 0) For digital only testing it is possible to generate the processing clock from the FEM card on board clocks. For multi board systems, the master board will be set to use the crystal and all the others will use a clock looped from this board. See <a class="el" href="group__toplevel.html#ga025c83ac0730f5860d3257cbf1263957">xsp3_clocks_setup</a> The processing register settings and BRAM contents are then loaded using <a class="el" href="group__toplevel.html#ga922527587ac747570235681e0d547e58">xsp3_restore_settings</a> The overall run flags should then be set to specify if whether playback data is to be used, whether scope mode debug data should be stored and whether scalers should be recorded. See <a class="el" href="group__toplevel.html#ga922527587ac747570235681e0d547e58">xsp3_restore_settings</a> The timing control register allows the acquisition enable/disable and time frame number to come from either software control (typically for a quick test) or from hardware (for accurately timed multi-frame experiments) See <a class="el" href="group__toplevel.html#ga770b2fa940753aafa9ed6891d2e90f25">xsp3_set_glob_timeA</a> and <a class="el" href="group__toplevel.html#ga6efddbcfd9d2ae04b68c6237f60ff7f4">xsp3_set_glob_timeFixed</a> </p>
<h3><a class="anchor" id="software_user_setup"></a>
User Settings</h3>
<p>The system now needs to need set up to match user specifiable values. In particular the energy windows and RoI positions need to be set to match the energy of the element(s) of interest. Two in windows scalers are provided per channel, typically used to measure the counts in the main characteristic peak of 1 or 2 elements See <a class="el" href="group__toplevel.html#ga370b5f701a5ee1825f83968f4304719f">xsp3_set_window</a> The Histogram data is usually set to collect the full spectrum in 4096 energy bins. Various debug modes are available, but not required for user data. To reduce the data volume, it is also possible to collect regions of interest around the peaks of interest. In this case the total size of each spectrum is reduced from 12 bits = 4096 bins to 11..1 bits =&gt; 2048 .. 2 bins. First the Spectra size is set using <a class="el" href="group__toplevel.html#gaf0857c343325d92e949074f510511544">xsp3_format_run</a> and then if required RoI are set using <a class="el" href="group__toplevel.html#gabc8cf6682f5430f6ae5461e5a234896f">xsp3_set_roi</a> </p>
<h3><a class="anchor" id="Data"></a>
Collection</h3>
<p>Once setup the histogramming memory is cleared using <a class="el" href="group__toplevel.html#gaf818e75dbb4e6a52192705c70dfac1fd">xsp3_histogram_clear</a>. Then the system is started using <a class="el" href="group__toplevel.html#gaf3b1a4949881a95c76bad27b1b3f5783">xsp3_histogram_start</a> If the timing control has been set to a fixed frame from software control, counting then starts. If the timing control has been set to use the external timing inputs, counting is armed, but will occur only when the timing veto input is asserted. If the acqusition is to be software timed, wait for the desired time and then counting disabled using <a class="el" href="group__toplevel.html#ga6611bffd6c764d6dc971ac0f3c13cf75">xsp3_histogram_stop</a> If timing if being controlled by hardware, the external timing generator must determine when the exposure is finished. After this call <a class="el" href="group__toplevel.html#ga6611bffd6c764d6dc971ac0f3c13cf75">xsp3_histogram_stop</a> to flush remaining data. </p>
<h3><a class="anchor" id="software_data_access"></a>
Data Access</h3>
<p>The histogram data is stored in /dev/shm shared memory on the Linux server. It can be read at any time, accepting that data read will be slightly stale while histogramming is running. At the end of the experiment, after calling <a class="el" href="group__toplevel.html#ga6611bffd6c764d6dc971ac0f3c13cf75">xsp3_histogram_stop</a>, poll <a class="el" href="group__internal.html#gab4379e74d2774df62d86f22328049ed9">xsp3_histogram_is_busy</a> twice to check that the histogramming threads have flushed any network stack buffers. The histogram data can then read read using any of <a class="el" href="group__toplevel.html#ga48dac2327cda3dd127ff6f36d177a403">xsp3_histogram_read4d</a>, <a class="el" href="group__toplevel.html#ga75a51e96d7ad2e2f3d4be4b787f66d9d">xsp3_histogram_read3d</a> or <a class="el" href="group__toplevel.html#ga88697faf20c618ef49135fc935e4b016">xsp3_histogram_read_chan</a> The scaler data is stored in a hardware counter during an acquistion and then transfered to DRAM on the FEM at the end of each frame. For multi-frame experiments, data can be read from the previous frame while the next is counting. To check the DMA channel has written data to memory use <a class="el" href="group__fullcontrol.html#ga5b46ff9baf93c4a7e3839c0eba6c4cd7">xsp3_dma_check_desc</a> The raw scaler data is then read using <a class="el" href="group__toplevel.html#ga6e31a5956682ff9886ed317965c512a3">xsp3_scaler_read</a></p>
<h2><a class="anchor" id="registers"></a>
Register Layout</h2>
<p>XSPRESS3 register space memory is mapped at 0xA0000000 on a 16 MByte boundary. It is split into 16 “channels” using the top 4 bits of my address space. Channel 0..7(8) will be physical channels and channel 15 is the global register. The remaining channels 10..14 are reserved for future use.<br/>
<br/>
 Within a channel, the top next 4 bits down select a region. Regions 0..8 (plus expansion) address block RAMs with varying sizes. Region 15 contains 30 registers. </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define XSP3_REGION_RAM_TESTPAT     1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_RESET_TAIL  2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_QUOTIENT    3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_ROI         4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_EVENT_TAIL  5</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_PWL_SERVO   6</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_PILEUP_TIME 7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_AUX1        8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_SERVO_TAIL  9</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_EVENT_LEAD  10</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_WIDTH_TIME  11</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_XTK_MAP     12</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_RAM_XTK_SHAPE   13</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_REGION_GLOB_REG        15</span></div>
</div><!-- fragment --><p> Address Bits </p>
<pre class="fragment"> * 23..20   Channel Address
 * 19..16   Region (BRAM sel or Regs)
 * 15..2    BRAM addresses
 * 7 ..2    Register select
 * </pre><h2><a class="anchor" id="network_config"></a>
Network Configuration</h2>
<p>The default network setup is (excluding the site network connection):</p>
<pre class="fragment"> * 1GBit Copper network for conbtrol communinication between the PC and the XSPRESS3 box. With more thean 1 XSPRESS3 box connected this netwrok uses a ethernt switch
 * A private network with 64 addresses allocated:
 * eth1      Link encap:Ethernet  HWaddr d4:ae:52:7d:5f:84
 *          inet addr:192.168.0.1  Bcast:192.168.0.63  Mask:255.255.255.192
 *          inet6 addr: fe80::d6ae:52ff:fe7d:5f84/64 Scope:Link
 *          UP BROADCAST RUNNING MULTICAST  MTU:9000  Metric:1
 *          RX packets:1567 errors:0 dropped:5766 overruns:0 frame:0
 *          TX packets:158 errors:0 dropped:0 overruns:0 carrier:0
 *          collisions:0 txqueuelen:1000
 *          RX bytes:173937 (169.8 KiB)  TX bytes:37252 (36.3 KiB)
 *          Interrupt:48 Memory:da000000-da012800
 *
 * A 10GBit Fibre network for data transfer, point to point with 4 addresses allocated. With more that 1 XSPRESS3 box there would be multiple 10G Ports on the PC with multiple 4 address range subnets
 *
 * ifconfig eth2
 * eth2      Link encap:Ethernet  HWaddr 00:07:43:05:7c:65
 *          inet addr:192.168.0.65  Bcast:192.168.0.67  Mask:255.255.255.252
 *          inet6 addr: fe80::207:43ff:fe05:7c65/64 Scope:Link
 *          UP BROADCAST RUNNING MULTICAST  MTU:9000  Metric:1
 *          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
 *          TX packets:702 errors:0 dropped:0 overruns:0 carrier:0
 *          collisions:0 txqueuelen:1000
 *          RX bytes:0 (0.0 B)  TX bytes:154963 (151.3 KiB)
 *          Interrupt:41 Memory:dd7fe000-dd7fefff
 *
 * Note the carefully picked subnet masks etc and the MTU 9000

 * We then have a script that should be executed automatically at boot.
 *
 * cat /etc/init.d/xspress3.sh
#!/bin/bash
#
# static-arp        This is to register a static ARP address in the arp table at boot
#
# Kept as simple as possible hopefully this will auto register the associated
# MAC with the private network address to allow the machine to communicate with the
# test boards for xspress3
#
# Derived from work by Duncan Russell, by William Helsby


PATH=/sbin:/bin:/usr/bin:/usr/sbin

arp -i eth2 -s 192.168.0.66 02:00:00:00:00:00
#route -v add -host 192.168.0.66 eth2

# Setting default and max buffer sizes for networking.
sysctl -w net.core.rmem_max=1073741824
sysctl -w net.core.rmem_default=1073741824
 *
 * </pre> <h2><a class="anchor" id="errors"></a>
Error Codes</h2>
<p>The following error codes maybe returned; </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define XSP3_OK                 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_ERROR              -1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_INVALID_PATH       -2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_ILLEGAL_CARD       -3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_ILLEGAL_SUBPATH    -4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_INVALID_DMA_STREAM -5</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_RANGE_CHECK        -6</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_INVALID_SCOPE_MOD  -7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define XSP3_OUT_OF_MEMORY      -8</span></div>
</div><!-- fragment --> <h1><a class="anchor" id="revisions"></a>
"Revison History"</h1>
<p>1.0.0 Original Release. 2.0.0 8/5/2014 API supporting event assembly processing in software and scalers in software. Note: User code should now check for histogramming threads busy using <a class="el" href="group__toplevel.html#gac86da3c2d625a6a872847d2b6edca84a">xsp3_histogram_is_any_busy</a> rather than <a class="el" href="group__internal.html#gab4379e74d2774df62d86f22328049ed9">xsp3_histogram_is_busy</a> as new function check all cards and all channels as necessary. User code should use <a class="el" href="group__toplevel.html#gac087294ee7be16def702c5e44b901f41">xsp3_scaler_check_progress</a> to check progress through time frames. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Sep 11 2015 15:30:19 for xspress3api by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
